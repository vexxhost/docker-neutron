name: build

on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main
      - stable/**

jobs:
  image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
      pull-requests: write
    steps:
      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/neutron
          ref: 7708cda01e9002a97b100a057a133f1e5798c657 # stable/2025.1

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/neutron-dynamic-routing
          ref: c53a910ecfe3f626e18ccbac0651735a3413e2d1 # stable/2025.1

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/neutron-vpnaas
          ref: faac856749ea780a72be2d7d1f32b30b791eab74 # stable/2025.1

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/networking-baremetal
          ref: 0f8ab8318214edeef1a2ef74d3e5796cfe963845 # stable/2025.1

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/networking-generic-switch
          ref: 2481e27dbeb8e62f796678b96396269f7c93007b # stable/2025.1

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: vexxhost/neutron-policy-server
          ref: a215317bfa147f29dd4e85ff96a54982384c8ba1 # main

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: vexxhost/neutron-ovn-network-logging-parser
          ref: 3895d8f9d004e612c71b4f798d31c758e113946b # main

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/tap-as-a-service
          ref: 5361d044747bd67133008d75425b06abe25ba64d # stable/2025.1

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: vexxhost/atmosphere
          ref: stable/2025.1 # stable/2025.1
          path: vexxhost/atmosphere

      - uses: vexxhost/docker-atmosphere/.github/actions/build-image@main
        with:
          image-name: neutron
          build-contexts: |
            neutron=openstack/neutron
            neutron-dynamic-routing=openstack/neutron-dynamic-routing
            neutron-vpnaas=openstack/neutron-vpnaas
            networking-baremetal=openstack/networking-baremetal
            networking-generic-switch=openstack/networking-generic-switch
            neutron-policy-server=vexxhost/neutron-policy-server
            neutron-ovn-network-logging-parser=vexxhost/neutron-ovn-network-logging-parser
            tap-as-a-service=openstack/tap-as-a-service
            ovsinit-src=vexxhost/atmosphere/crates/ovsinit
          push: ${{ github.event_name != 'pull_request' }}
